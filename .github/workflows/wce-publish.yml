name: wce-sign-notarize-publish

on:
    release:
        types:
            - published

    workflow_dispatch:

jobs:
    build-and-upload-assets-on-linux:
        runs-on: ubuntu-latest

        steps:
            - name: ğŸ“– Context
              env:
                  GITHUB_CONTEXT: ${{ toJson(github) }}
              run: echo "$GITHUB_CONTEXT"

            - name: ğŸ“¥ Checkout
              uses: actions/checkout@v2

            - name: ğŸ·ï¸  Get Node Version
              run: |
                  cat .nvmrc
                  echo "::set-output name=nodeversion::$(cat .nvmrc)"
              id: get-node-version

            - name: ğŸ·ï¸  Use Node.js ${{ steps.get-node-version.outputs.nodeversion }}
              if: ${{ !env.ACT }}
              uses: actions/setup-node@v2
              with:
                  node-version: ${{ steps.get-node-version.outputs.nodeversion }}
                  cache: "npm"

            - name: ğŸ·ï¸  Use Node.js ${{ steps.get-node-version.outputs.nodeversion }}
              if: ${{ env.ACT }}
              uses: actions/setup-node@v2
              with:
                  node-version: ${{ steps.get-node-version.outputs.nodeversion }}

            - name: ğŸ“¦ Install Dependencies
              run: |
                  env
                  echo "npm: $(npm --version)"
                  echo "node: $(node --version)"
                  npm install

            - name: ğŸ” Verify Dependencies
              run: |
                  ls -la
                  npm list --depth=1

            - name: ğŸ§° Install Tools
              run: |
                  sudo apt-get update
                  sudo apt-get install -y jq binutils

            - name: ğŸ”¨ Build
              run: |
                  npm run electron:build:ci
              env:
                  CI: false

            - name: ğŸ“¦ Package
              id: package
              run: |
                  echo "::set-output name=TAG::v$(cat package.json | jq -r '.version')"
                  npm exec -c "electron-builder --publish \"never\""
              env:
                  GITHUB_TOKEN: ${{ secrets.github_token }}
                  EP_PRE_RELEASE: true
                  USE_HARD_LINKS: false

            - name: ğŸŸ© Build Succeeded
              run: |
                  ls -alh dist | grep webviz-config-editor && du -sh dist || true
              if: ${{ success() }}

            - name: ğŸ“¤ Upload Release Assets
              uses: shogo82148/actions-upload-release-asset@v1
              with:
                  upload_url: ${{ github.event.release.upload_url }}
                  asset_path: dist/*.[deb|AppImage]
                  github_token: ${{ secrets.github_token }}

            - name: ğŸ—„ï¸ Archive Binary
              uses: actions/upload-artifact@v2
              with:
                  name: dist-nix
                  path: dist
              if: ${{ success() }}

            - name: ğŸŸ¥ Build Failed - Output Build Logs
              run: |
                  cat /Users/runner/.npm/_logs/*-debug.log || true
              if: ${{ failure() || cancelled() }}

            - name: ğŸŸ¥ Build Failed - Archive Build Logs
              uses: actions/upload-artifact@v2
              with:
                  name: logs
                  path: /Users/runner/.npm/_logs
              if: ${{ failure() || cancelled() }}

            # Make sure no secrets or certs are left on the runner
            - name: ğŸ§¹ Cleanup Files After Run
              run: |
                  rm -rf *
                  ls -la
              if: ${{ always() }}

    build-and-publish-on-windows:
        runs-on: windows-latest
        if: ${{ false }} # disable for now

        steps:
            - name: ğŸ“– Context
              env:
                  GITHUB_CONTEXT: ${{ toJson(github) }}
              run: echo "$GITHUB_CONTEXT"

            - name: ğŸ“¥ Checkout
              uses: actions/checkout@v2

            - name: ğŸ·ï¸  Get Node Version
              run: |
                  Set-PSDebug -Trace 1
                  $filePath = "D:\a\webviz-config-editor\webviz-config-editor\.nvmrc"
                  Get-Content $filePath -Raw
                  $content = Get-Content $filePath -Raw
                  echo "::set-output name=nodeversion::$content"
              id: get-node-version

            - name: ğŸ·ï¸  Use Node.js ${{ steps.get-node-version.outputs.nodeversion }}
              if: ${{ !env.ACT }}
              uses: actions/setup-node@v2
              with:
                  node-version: ${{ steps.get-node-version.outputs.nodeversion }}
                  cache: "npm"

            - name: ğŸ·ï¸  Use Node.js ${{ steps.get-node-version.outputs.nodeversion }}
              if: ${{ env.ACT }}
              uses: actions/setup-node@v2
              with:
                  node-version: ${{ steps.get-node-version.outputs.nodeversion }}

            - name: Get MSFT Cert
              id: write_file
              uses: timheuer/base64-to-file@v1
              with:
                  fileName: "webviz_msft.p12"
                  encodedString: ${{ secrets.CERT_MSFT_WEBVIZ_P12_B64 }}

            - name: ğŸ“¦ Install Dependencies
              run: |
                  Set-PSDebug -Trace 1
                  node --version
                  npm --version
                  npm install

            - name: ğŸ” Verify Dependencies
              run: |
                  cmd /r dir
                  npm list --depth=1

            - name: ğŸ”¨ Build
              run: |
                  npm run electron:build:ci
              env:
                  CI: false

            - name: ğŸ“¦ Package
              id: package
              run: |
                  $p = get-content package.json | ConvertFrom-Json
                  echo "::set-output name=TAG::v$($p.version)"
                  npm exec -c 'electron-builder --publish "never"'
              env:
                  GITHUB_TOKEN: ${{ secrets.github_token }}
                  EP_PRE_RELEASE: true
                  USE_HARD_LINKS: false
                  WIN_CSC_LINK: ${{ steps.write_file.outputs.filePath }}
                  WIN_CSC_KEY_PASSWORD: ${{ secrets.CERT_MSFT_WEBVIZ_P12_PASSWORD }}

            - name: ğŸŸ© Build Succeeded
              run: |
                  cmd /r dir .\dist
              if: ${{ success() }}

            - name: ğŸ“¤ Create Release and Upload Artifacts
              if: ${{ !contains(github.ref, 'main') }}
              uses: ncipollo/release-action@v1
              with:
                  allowUpdates: true
                  prerelease: true
                  artifacts: "dist/latest.yml,dist/*.exe,dist/*.blockmap"
                  omitBody: true
                  tag: ${{ steps.package.outputs.TAG }}
                  token: ${{ secrets.github_token }}

            - name: ğŸ—„ï¸ Archive Binary
              uses: actions/upload-artifact@v2
              with:
                  name: dist-win
                  path: dist
              if: ${{ success() }}
